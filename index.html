<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Background Check (Beeeta)</title>
  <meta content="width=device-width,initial-scale=1" name="viewport"/>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #000000;
      --muted-color: #666666;
      --border-color: #eeeeee;
      --code-bg: #f6f8fa;
      --input-bg: #ffffff;
      --input-border: #d1d5da;
    }
    body.dark-mode {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --muted-color: #a0a0a0;
      --border-color: #333333;
      --code-bg: #2d2d2d;
      --input-bg: #2d2d2d;
      --input-border: #404040;
    }
    body {
      font-family: system-ui, Arial, sans-serif;
      max-width: 920px;
      margin: 32px auto;
      padding: 0 16px;
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    #theme-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--text-color);
      border-radius: 4px;
      font-size: 14px;
    }
    h1 { font-size: 20px; margin-bottom: 16px; }
    h2 { margin-top: 32px; font-size: 18px; }
    #box { display: flex; gap: 8px; }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--input-border);
    }
    button {
      padding: 12px 16px;
      font-size: 16px;
      cursor: pointer;
      background-color: var(--input-bg);
      color: var(--text-color);
      border: 1px solid var(--input-border);
    }
    button:hover { opacity: 0.8; }
    .muted { color: var(--muted-color); font-size: 14px; }
    .section { margin-top: 24px; }
    .row { padding: 8px 0; border-bottom: 1px solid var(--border-color); }
    .status { margin-top: 8px; }
    code { background: var(--code-bg); padding: 2px 4px; }
    .group-title { font-weight: 600; margin: 12px 0 8px; display:flex; align-items:center; gap:12px; cursor: pointer; user-select: none; }
    .group-title .title-text { cursor: pointer; }
    .group-title .master-wrap { display:flex; align-items:center; gap:6px; cursor: default; }
    .checkboxes label { margin: 4px 12px 4px 0; display: inline-block; }
    .group-wrap { margin-bottom: 8px; border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; }
    .group-body { display: none; margin-top: 8px; }
    .group-body.show { display: block; }
  </style>
</head>
<body>
  <button id="theme-toggle">üåô Dark Mode</button>
  <h1 id="page-title">Background Check (Beta)</h1>
  <div id="box">
    <input autocomplete="off" id="nameInput" placeholder="Enter educator name..." type="text"/>
    <button id="runBtn">Run Check</button>
  </div>
  <div class="muted">Press Enter or click Run Check to build searches for the name with selected keywords.</div>
  <div class="section">
    Filters
    <div class="checkboxes" id="filters"></div>
  </div>
  <div class="section">
    Planned searches
    <div id="planned"></div>
  </div>
  <div class="section">
    Results
    <div class="status muted" id="results">No searches run yet.</div>
  </div>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Theme toggle functionality
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
      body.classList.add('dark-mode');
      themeToggle.textContent = '‚òÄÔ∏è Light Mode';
    }
    themeToggle.addEventListener('click', function() {
      body.classList.toggle('dark-mode');
      if (body.classList.contains('dark-mode')) {
        themeToggle.textContent = '‚òÄÔ∏è Light Mode';
        localStorage.setItem('theme', 'dark');
      } else {
        themeToggle.textContent = 'üåô Dark Mode';
        localStorage.setItem('theme', 'light');
      }
    });

    // Co‚Äëoccurrence keyword sets by language
    const FLAGGED_EN = [
      'MCC','Mathias Corvinus Collegium','politics','policy','education','teaching','research','conference','conference speech','keynote speech',
      'presentation','public speech','panel discussion','summit','lecture','course','debate','opinion','interview'
    ];
    const FLAGGED_HU = [
      'MCC','Mathias Corvinus Collegium','politika','politikai','oktat√°s','tan√≠t√°s','kutat√°s','konferencia','konferencia-el≈ëad√°s','nyit√≥el≈ëad√°s',
      'el≈ëad√°s','nyilv√°nos besz√©d','panelbesz√©lget√©s','cs√∫cstal√°lkoz√≥','el≈ëad√°s','tanfolyam','vita','v√©lem√©ny','interj√∫'
    ];
    const FLAGGED_RO = [
      'MCC','Mathias Corvinus Collegium','politicƒÉ','politici','educa»õie','predare','cercetare','conferin»õƒÉ','discurs la conferin»õƒÉ','discurs principal',
      'prezentare','discurs public','discu»õie de panel','summit','prelegere','curs','dezbatere','opinie','interviu'
    ];

    // Discovery sources
    const DISCOVERY = ['Google Scholar','ORCID','ResearchGate','LinkedIn','Twitter','Facebook','Instagram','Publications','TikTok'];

    // DOM
    const nameInput = document.getElementById('nameInput');
    const runBtn = document.getElementById('runBtn');
    const filtersEl = document.getElementById('filters');
    const plannedEl = document.getElementById('planned');
    const resultsEl = document.getElementById('results');
    if (!nameInput || !runBtn || !filtersEl || !plannedEl || !resultsEl) {
      console.warn('Inputs not found in DOM.');
      return;
    }

    // Render a row with master checkbox and children
    function renderGroup(title, key, items) {
      const children = items.map(function (label, i) {
        return '<label><input type="checkbox" class="flt" data-group="' + key + '" data-index="' + i + '" checked> ' + label + '</label>';
      }).join('');
      const masterId = 'master-' + key;
      return [
        '<div class="row group-wrap" data-group-wrap="' + key + '">',
          '<div class="group-title" data-group="' + key + '">',
            '<span class="title-text">' + title + '</span>',
            '<label class="master-wrap"><input type="checkbox" class="master" id="' + masterId + '" data-master="' + key + '" checked> All</label>',
          '</div>',
          '<div class="group-body show" data-body="' + key + '">' + children + '</div>',
        '</div>'
      ].join('');
    }

    // Render all rows
    function renderFilters() {
      filtersEl.innerHTML =
        renderGroup('‚ñº Co‚Äëoccurrence keywords (English)', 'flagged-en', FLAGGED_EN) +
        renderGroup('‚ñº Co‚Äëoccurrence keywords (Hungarian)', 'flagged-hu', FLAGGED_HU) +
        renderGroup('‚ñº Co‚Äëoccurrence keywords (Romanian)', 'flagged-ro', FLAGGED_RO) +
        renderGroup('Discovery sources', 'discovery', DISCOVERY) +
        '<div class="muted">Uncheck any items to exclude before running. Click on group titles to collapse/expand.</div>';

      // Enable collapsible behavior
      setupCollapsible('flagged-en');
      setupCollapsible('flagged-hu');
      setupCollapsible('flagged-ro');
      setupCollapsible('discovery');

      // Wire up master checkbox behavior for co-occurrence groups
      setupMaster('flagged-en');
      setupMaster('flagged-hu');
      setupMaster('flagged-ro');

      // Initialize indeterminate states after initial render
      updateMasterFromChildren('flagged-en');
      updateMasterFromChildren('flagged-hu');
      updateMasterFromChildren('flagged-ro');
    }

    // Collapsible logic
    function setupCollapsible(groupKey) {
      const header = filtersEl.querySelector('.group-title[data-group="' + groupKey + '"] .title-text');
      const body = filtersEl.querySelector('.group-body[data-body="' + groupKey + '"]');
      if (header && body) {
        header.addEventListener('click', function() {
          body.classList.toggle('show');
        });
      }
    }

    // Master checkbox handlers
    function getMaster(groupKey) {
      return filtersEl.querySelector('input.master[data-master="' + groupKey + '"]');
    }
    function getChildren(groupKey) {
      return Array.from(filtersEl.querySelectorAll('input.flt[data-group="' + groupKey + '"]'));
    }
    function setAllChildren(groupKey, checked) {
      getChildren(groupKey).forEach(cb => { cb.checked = checked; });
    }
    function updateMasterFromChildren(groupKey) {
      const master = getMaster(groupKey);
      if (!master) return;
      const children = getChildren(groupKey);
      const total = children.length;
      const checkedCount = children.filter(cb => cb.checked).length;
      master.indeterminate = checkedCount > 0 && checkedCount < total;
      master.checked = checkedCount === total;
    }
    function setupMaster(groupKey) {
      const master = getMaster(groupKey);
      const children = getChildren(groupKey);
      if (!master) return;
      master.addEventListener('change', function() {
        setAllChildren(groupKey, master.checked);
        master.indeterminate = false;
      });
      children.forEach(cb => {
        cb.addEventListener('change', function() {
          updateMasterFromChildren(groupKey);
        });
      });
    }

    // Initial render
    renderFilters();

    // Build queries from all rows
    function buildQueries(fullName) {
      const quoted = '"' + fullName.trim() + '"';
      const picks = { 'flagged-en': [], 'flagged-hu': [], 'flagged-ro': [], 'discovery': [] };
      filtersEl.querySelectorAll('input.flt').forEach(function (box) {
        if (!box.checked) return;
        const grp = box.getAttribute('data-group');
        const label = (box.parentElement ? box.parentElement.textContent : '').trim();
        if (!label) return;
        if (grp === 'discovery') picks['discovery'].push(label);
        else if (grp === 'flagged-en') picks['flagged-en'].push(label);
        else if (grp === 'flagged-hu') picks['flagged-hu'].push(label);
        else if (grp === 'flagged-ro') picks['flagged-ro'].push(label);
      });
      const cooccurrence = []
        .concat(picks['flagged-en'].map(k => quoted + ' "' + k + '"'))
        .concat(picks['flagged-hu'].map(k => quoted + ' "' + k + '"'))
        .concat(picks['flagged-ro'].map(k => quoted + ' "' + k + '"'));
      const discovery = picks['discovery'].map(k => quoted + ' ' + k);
      return { cooccurrence, discovery, standalone: [quoted] };
    }

    // Planned searches view
    function renderPlanned(qs) {
      function makeList(title, arr) {
        return '<div class="row"><strong>' + title + ':</strong> '
          + arr.map(q => '<code>' + q + '</code>').join(' ¬∑ ')
          + '</div>';
      }
      plannedEl.innerHTML =
        makeList('Co-occurrence', qs.cooccurrence) +
        makeList('Discovery', qs.discovery) +
        makeList('Standalone', qs.standalone);
    }

    // Netlify proxy call
    async function braveSearch(q) {
      const res = await fetch('/api/search?q=' + encodeURIComponent(q));
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      return data.items || [];
    }

    // Throttle
    function wait(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // Run
    async function onRun() {
      const fullName = nameInput.value.trim();
      if (!fullName) { alert('Type a full name first.'); return; }
      const queries = buildQueries(fullName);
      renderPlanned(queries);
      resultsEl.innerHTML = 'Searching...';
      const allQueries = [].concat(queries.cooccurrence, queries.discovery, queries.standalone);
      const sections = []
      for (const q of allQueries) {
        try {
          const items = await braveSearch(q);
          sections.push({ q, items });
        } catch (err) {
          sections.push({ q, items: [], error: String(err) });
        }
        await wait(1000); // 1 req/sec
      }
      resultsEl.innerHTML = sections.map(function (sec) {
        const header = '<div class="row"><strong>Query:</strong> <code>' + sec.q + '</code></div>';
        if (sec.error) return header + '<div class="row muted">Error: ' + sec.error + '</div>';
        if (!sec.items.length) return header + '<div class="row muted">No results.</div>';
        const list = sec.items.map(function (it) {
          return '<div class="row">'
            + '<a href="' + it.link + '" target="_blank" rel="noopener">' + it.title + '</a>'
            + '<div class="muted">' + it.snippet + '</div>'
          + '</div>';
        }).join('');
        return header + list;
      }).join('');
    }

    // Events
    nameInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') onRun();
    });
    runBtn.addEventListener('click', onRun);
  });
  </script>
</body>
</html>
